name: 'Conventional Release Automator'
description: 'Automated release workflow with conventional commits and changelog generation'
author: hsayed

inputs:
  node-version:
    description: 'Node.js version to use'
    required: false
    default: '20'
  package-manager:
    description: 'Package manager to use (npm, pnpm, yarn)'
    required: false
    default: 'npm'
  build-command:
    description: 'Command to build the project'
    required: false
    default: 'npm run build'
  skip-build:
    description: 'Skip the build step'
    required: false
    default: 'false'
  package-command:
    description: 'Command to package artifacts (e.g., "npm pack" or "vsce package")'
    required: false
    default: ''
  upload-artifacts:
    description: 'Glob pattern of artifacts to upload to GitHub release (e.g., "*.vsix" or "*.tgz")'
    required: false
    default: ''
  generate-changelog:
    description: 'Generate and commit CHANGELOG.md file to repository'
    required: false
    default: 'false'
  changelog-file:
    description: 'Path to the changelog file'
    required: false
    default: 'CHANGELOG.md'
  changelog-template:
    description: 'Changelog template type: "custom" (uses handlebars templates) or "compact" (uses release-it default)'
    required: false
    default: 'custom'
  generate-release-notes:
    description: 'Generate release notes for GitHub release'
    required: false
    default: 'true'
  publish-marketplace:
    description: 'Publish to VS Code Marketplace (requires vsce-pat)'
    required: false
    default: 'false'
  github-token:
    description: 'GitHub token for creating releases'
    required: true
    default: ${{ github.token }}
  vsce-pat:
    description: 'VS Code Marketplace Personal Access Token'
    required: false
    default: ''

outputs:
  version:
    description: 'The version that was released'
    value: ${{ steps.release.outputs.version }}
  tag:
    description: 'The git tag that was created'
    value: ${{ steps.release.outputs.tag }}
  release-url:
    description: 'The URL of the created GitHub release'
    value: ${{ steps.release.outputs.release-url }}

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}

    - name: Install dependencies
      shell: bash
      run: |
        if [ "${{ inputs.package-manager }}" = "pnpm" ]; then
          npm install -g pnpm
          pnpm install
        elif [ "${{ inputs.package-manager }}" = "yarn" ]; then
          yarn install
        else
          npm install
        fi

    - name: Build
      if: ${{ inputs.skip-build != 'true' }}
      shell: bash
      run: ${{ inputs.build-command }}

    - name: Configure Git
      shell: bash
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Install release tools
      shell: bash
      run: |
        # Install core release tools
        npm install -g release-it @release-it/conventional-changelog auto-changelog
        # Install vsce if marketplace publishing is enabled
        if [ "${{ inputs.publish-marketplace }}" = "true" ]; then
          npm install -g @vscode/vsce
        fi

    - name: Create Handlebars Setup
      shell: bash
      run: |
        cat > /tmp/setup.js << 'EOF'
        module.exports = function (Handlebars) {
            Handlebars.registerHelper('replaceCommit', function (context) {
                const commit = /.*?(chore|feat|fix|perf|refactor|style|docs|test|ci|build|deprecate)(\((.*?)\))?!?: (.*?)$/g;
                const string = context.fn(this);
                const parsed = Array.from(string.matchAll(commit) ?? [])[0] ?? [];
                const [, type = '', , scope = '', title = ''] = parsed;
                let result = "";
                if (scope) {
                    result = `${type}(${scope.toLowerCase()}): ${title}`
                } else {
                    result = `${type}: ${title}`;
                }
                let emoji = "";
                switch (type) {
                    case 'chore': emoji = "ðŸ”¨"; break;
                    case 'feat': emoji = "âœ¨"; break;
                    case 'fix': emoji = "ðŸž"; break;
                    case 'perf': emoji = "âš¡ï¸"; break;
                    case 'refactor': emoji = "â™»ï¸"; break;
                    case 'style': emoji = "ðŸŽ¨"; break;
                    case 'deprecate': emoji = "âš ï¸"; break;
                    case 'docs': emoji = "ðŸ“"; break;
                    case 'ci': emoji = "ðŸ¤–"; break;
                }
                return `${emoji} ${result}` || 'empty commit name';
            });

            Handlebars.registerHelper('replaceTitle', function (context) {
                const string = context.fn(this);
                return string.replace('v', '');
            });

            Handlebars.registerHelper('commit-parser', (merges, commits, options) => {
                const commitsFromMerges = merges.map((merge) => merge.commit);
                const result = commits.concat(commitsFromMerges);
                return options.fn(result);
            });

            Handlebars.registerHelper('lookup', function (obj, index) {
                return obj[index];
            });
        };
        EOF

    - name: Create Handlebars Template
      shell: bash
      run: |
        cat > /tmp/template.hbs << 'EOF'
        {{#with (lookup releases 0)}}
          {{#commit-parser merges commits}}
              {{#commit-list this heading="# **What's Changed**" message='.*?(chore|feat|fix|perf|refactor|style|docs|test|ci|build|deprecate)(\(.*?\))?!?:' exclude='[bB]reaking [cC]hange:|[bB]reaking:|chore\(release\)' }}
                - {{#replaceCommit}}{{subject}}{{/replaceCommit}} by @{{author}} [({{shorthash}})]({{href}})
              {{/commit-list}}
          {{/commit-parser}}
          {{#if tag}}
            **Full Changelog:** [{{diff}}]({{href}})
          {{/if}}
        {{/with}}
        EOF

    - name: Create Release-it Config
      shell: bash
      env:
        GENERATE_CHANGELOG: ${{ inputs.generate-changelog }}
        CHANGELOG_FILE: ${{ inputs.changelog-file }}
        GENERATE_RELEASE_NOTES: ${{ inputs.generate-release-notes }}
        CHANGELOG_TEMPLATE: ${{ inputs.changelog-template }}
      run: |
        # Determine template paths based on changelog-template input
        if [ "$CHANGELOG_TEMPLATE" = "custom" ]; then
          TEMPLATE_PATH="/tmp/template.hbs"
          SETUP_PATH="/tmp/setup.js"
          CHANGELOG_CMD="npx auto-changelog --commit-limit false --unreleased --template ${TEMPLATE_PATH} --handlebars-setup ${SETUP_PATH}"
          GIT_CHANGELOG="npx auto-changelog --stdout --commit-limit false --unreleased --template ${TEMPLATE_PATH} --handlebars-setup ${SETUP_PATH}"
        else
          # Use compact template from release-it
          CHANGELOG_CMD="npx auto-changelog --commit-limit false --unreleased --template https://raw.githubusercontent.com/release-it/release-it/main/templates/changelog-compact.hbs"
          GIT_CHANGELOG="npx auto-changelog --stdout --commit-limit false --unreleased --template https://raw.githubusercontent.com/release-it/release-it/main/templates/changelog-compact.hbs"
        fi
        
        # Build the after:npm:bump hooks
        if [ "$GENERATE_CHANGELOG" = "true" ]; then
          if [ "$CHANGELOG_TEMPLATE" = "custom" ]; then
            # Custom template with full options 
            HOOKS="'npx auto-changelog --commit-limit false -p --output ${CHANGELOG_FILE} --template ${TEMPLATE_PATH} --handlebars-setup ${SETUP_PATH} > /dev/null 2>&1'"
          else
            # Simple version
            HOOKS="'npx auto-changelog -p --output ${CHANGELOG_FILE}'"
          fi
        else
          HOOKS="''"
        fi
        
        # Determine release notes command
        if [ "$GENERATE_RELEASE_NOTES" = "true" ]; then
          RELEASE_NOTES_CMD="\${changelog} --stdout --unreleased-only"
        else
          RELEASE_NOTES_CMD="echo 'Release v\${version}'"
        fi
        
        # Determine commit message style
        if [ "$CHANGELOG_TEMPLATE" = "custom" ]; then
          COMMIT_MSG="chore(release): v\${version}"
        else
          COMMIT_MSG="chore: release v\${version}"
        fi
        
        # Build conventional-changelog preset
        if [ "$CHANGELOG_TEMPLATE" = "custom" ]; then
          # Simple preset
          PRESET="'conventionalcommits'"
        else
          # Detailed preset with types 
          PRESET="{
                        name: 'conventionalcommits',
                        types: [
                            { type: 'feat', section: 'Features' },
                            { type: 'fix', section: 'Bug Fixes' },
                            {}
                        ]
                    }"
        fi
        
        cat > /tmp/.release-it.js << EOF
        /* eslint-disable no-template-curly-in-string */
        const changelog = \`${CHANGELOG_CMD}\`;

        module.exports = {
            plugins: {
                '@release-it/conventional-changelog': {
                    gitRawCommitsOpts: {
                        path: '.',
                    },
                    path: '.',
                    preset: ${PRESET},
                    infile: false,
                },
            },
            git: {
                commitMessage: "${COMMIT_MSG}",
                requireCleanWorkingDir: false,
                getLatestTagFromAllRefs: true,
                pushArgs: ['--follow-tags'],
                changelog: "${GIT_CHANGELOG}"
            },
            hooks: {
                'after:npm:bump': ${HOOKS},
            },
            github: {
                release: true,
                releaseName: "v\${version}",
                releaseNotes: \`${RELEASE_NOTES_CMD}\`,
            },
            npm: {
                publish: false,
            },
            verbose: true,
        };
        EOF

    - name: Run Release
      id: release
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        npx release-it --ci --config /tmp/.release-it.js
        VERSION=$(node -p "require('./package.json').version")
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "tag=v${VERSION}" >> $GITHUB_OUTPUT
        echo "release-url=https://github.com/${{ github.repository }}/releases/tag/v${VERSION}" >> $GITHUB_OUTPUT

    - name: Commit and Push CHANGELOG
      if: ${{ inputs.generate-changelog == 'true' }}
      shell: bash
      run: |
        if [ -f "${{ inputs.changelog-file }}" ]; then
          git add "${{ inputs.changelog-file }}"
          git commit --amend --no-edit
          git push --force-with-lease
        fi

    - name: Package Extension
      if: ${{ inputs.publish-marketplace == 'true' }}
      shell: bash
      run: npx vsce package

    - name: Package Artifacts
      if: ${{ inputs.package-command != '' }}
      shell: bash
      run: ${{ inputs.package-command }}

    - name: Upload Artifacts to Release
      if: ${{ inputs.upload-artifacts != '' }}
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        VERSION=$(node -p "require('./package.json').version")
        shopt -s nullglob
        files=(${{ inputs.upload-artifacts }})
        if [ ${#files[@]} -eq 0 ]; then
          echo "No files matching pattern '${{ inputs.upload-artifacts }}' found"
          exit 0
        fi
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "Uploading $file to release v${VERSION}"
            gh release upload "v${VERSION}" "$file" --clobber
          else
            echo "Warning: $file is not a file, skipping"
          fi
        done

    - name: Publish to VS Code Marketplace
      if: ${{ inputs.publish-marketplace == 'true' && inputs.vsce-pat != '' }}
      shell: bash
      env:
        VSCE_PAT: ${{ inputs.vsce-pat }}
      run: npx vsce publish -p $VSCE_PAT

branding:
  icon: 'package'
  color: 'blue'
